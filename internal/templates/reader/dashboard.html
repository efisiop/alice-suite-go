{{define "title"}}Reader Dashboard - Alice Suite{{end}}

{{define "nav"}}
<li class="nav-item">
    <a class="nav-link" href="/reader">Dashboard</a>
</li>
<li class="nav-item">
    <a class="nav-link" href="/reader/interaction">Reading</a>
</li>
<li class="nav-item">
    <a class="nav-link" href="/reader/statistics">Statistics</a>
</li>
<li class="nav-item">
    <a class="nav-link" href="#" id="logout-link-reader">Logout</a>
</li>
{{end}}

{{define "content"}}
<div class="row">
    <div class="col-md-12">
        <h1 class="mb-4">Reader Dashboard</h1>
        
        <div class="row mb-4">
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Start Reading</h5>
                        <p class="card-text">Continue your reading journey</p>
                        <a href="/reader/interaction" class="btn btn-primary">Open Book</a>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Reading Progress</h5>
                        <p class="card-text">View your reading statistics</p>
                        <a href="/reader/statistics" class="btn btn-outline-primary">View Stats</a>
                    </div>
                </div>
            </div>
            <div class="col-md-4">
                <div class="card">
                    <div class="card-body">
                        <h5 class="card-title">Help Requests</h5>
                        <p class="card-text">Get help from consultants</p>
                        <button class="btn btn-outline-primary" onclick="showHelpRequestDialog()">Request Help</button>
                    </div>
                </div>
            </div>
        </div>

        <div class="card">
            <div class="card-header">
                <h5>Recent Activity</h5>
            </div>
            <div class="card-body">
                <div id="recent-activity">
                    <p class="text-muted">Loading activity...</p>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Help Request Modal -->
<div class="modal fade" id="helpRequestModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title">Request Help</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
            </div>
            <div class="modal-body">
                <form id="help-request-form">
                    <div class="mb-3">
                        <label for="help-content" class="form-label">What do you need help with?</label>
                        <textarea class="form-control" id="help-content" rows="4" required></textarea>
                    </div>
                    <button type="submit" class="btn btn-primary">Submit Request</button>
                </form>
            </div>
        </div>
    </div>
</div>
{{end}}

{{define "scripts"}}
<script>
// Logout function is now in app.js (global), but we'll attach event listener here
function showHelpRequestDialog() {
    const modal = new bootstrap.Modal(document.getElementById('helpRequestModal'));
    modal.show();
}

// Load recent activity
document.addEventListener('DOMContentLoaded', function() {
    console.log('[dashboard.html] DOMContentLoaded fired');
    
    const token = getAuthToken();
    if (!token) {
        window.location.href = '/login';
        return;
    }

    // Attach logout handler (backup - app.js also handles this)
    const logoutLink = document.getElementById('logout-link-reader');
    if (logoutLink) {
        console.log('[dashboard.html] Found logout link, attaching handler');
        logoutLink.addEventListener('click', function(e) {
            e.preventDefault();
            console.log('[dashboard.html] Logout clicked');
            if (window.logout) {
                console.log('[dashboard.html] Calling window.logout()');
                window.logout();
            } else {
                console.error('[dashboard.html] window.logout is not defined!');
            }
        });
    } else {
        console.warn('[dashboard.html] Logout link not found');
    }

    // User info is loaded by app.js automatically
    // But let's also try loading it here as a backup (with longer delay to ensure app.js has loaded)
    setTimeout(function() {
        console.log('[dashboard.html] Checking for loadUserInfoInNavbar function...');
        const userNameBrand = document.getElementById('user-name-brand');
        console.log('[dashboard.html] user-name-brand element found:', !!userNameBrand);
        if (typeof loadUserInfoInNavbar === 'function') {
            console.log('[dashboard.html] Calling loadUserInfoInNavbar() as backup');
            loadUserInfoInNavbar();
        } else {
            console.error('[dashboard.html] loadUserInfoInNavbar function not found!');
        }
    }, 500);
    
    // Load recent activity (simplified)
    document.getElementById('recent-activity').innerHTML = '<p class="text-muted">No recent activity</p>';
});

// Handle help request submission
document.getElementById('help-request-form').addEventListener('submit', function(e) {
    e.preventDefault();
    const content = document.getElementById('help-content').value;
    const token = localStorage.getItem('auth_token');
    
    // Get user and book info (simplified)
    fetch('/auth/v1/user', {
        headers: {'Authorization': 'Bearer ' + token}
    })
    .then(res => res.json())
    .then(user => {
        // Assume first book for now
        return fetch('/rest/v1/help_requests?select=*', {
            method: 'POST',
            headers: {'Content-Type': 'application/json', 'Authorization': 'Bearer ' + token},
            body: JSON.stringify({
                user_id: user.id,
                book_id: 'alice-in-wonderland', // Default book ID
                content: content,
                status: 'pending'
            })
        });
    })
    .then(res => res.json())
    .then(data => {
        alert('Help request submitted successfully!');
        bootstrap.Modal.getInstance(document.getElementById('helpRequestModal')).hide();
        document.getElementById('help-request-form').reset();
    })
    .catch(err => {
        alert('Failed to submit help request');
    });
});
</script>
{{end}}

